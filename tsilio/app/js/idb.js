var _idb={db:null,log:console.log,indexedDB:window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,setLog:function(e){this.log=e||console.log},getListPromise:function(e,o,r,n){return new Promise(function(t,i){var s,c,u=[],d=function(e){(s=e.target.result)&&(u.push(s.value),s.continue())};_idb.log("IDBCursor - getListPromiseG - begin (os, ind, iBegin, iEnd):",e,o,r,n);var a=_idb.db.transaction(e),l=a.objectStore(e);o?(index=l.index(o),n||r?(c=n?IDBKeyRange.bound(r,n):IDBKeyRange.only(r),index.openCursor(c).onsuccess=d):index.openCursor().onsuccess=d):l.openCursor().onsuccess=d,l.openCursor().onerror=function(e){t(e)},a.oncomplete=function(i){_idb.log("IDBCursor - getListPromiseG - end (os, ind, iBegin, iEnd, #items):",e,o,r,n,u.length),t(u)},a.onerror=function(e){_idb.log("Error creating listG of projects",e.target),i(e)}})},getListTextSearch:function(e,o){return new Promise(function(r,n){var t,i,s,c=[],u=function(e){t=event.target.result,t?(c.push(t.value),t.continue()):_idb.log("IDBCursor - getListTextSearch cursor - No more events to read")},d=$m.iDB.db.transaction(e);i=d.objectStore(e).index("sKey"),s=IDBKeyRange.bound("a"+o.toLowerCase(),o.toLowerCase()+"z"),i.openCursor(s).onsuccess=u,d.oncomplete=function(e){_idb.log("IndexDB read completed - getListTextSearch - #Items: ",c.length),r(c)},d.onerror=function(e){_idb.log("Error creating list of items - getListTextSearch",e.target),n(e)}})},getItemPromise:function(e,o){return new Promise(function(r,n){var t={},i=_idb.db.transaction(e),s=i.objectStore(e),c=s.get(o);c.onerror=function(e){_idb.log("error retrieving single item from IDB: ",JSON.stringify(e)),t={}},c.onsuccess=function(e){_idb.log("Successfully retrieved single item from IDB: ",JSON.stringify(c.result)),t=c.result?c.result:{}},i.oncomplete=function(e){_idb.log("IndexedDB read completed - Single item: ",JSON.stringify(e)),r(t)},i.onerror=function(e){_idb.log("Error reading IndexedDB - Single item: ",JSON.stringify(e.target)),n(e)}})},getItemsById:function(e,o,r,n){return new Promise(function(t,i){var s,c,u=0,d=[],a=function(t){if(cursor=event.target.result,cursor){if(cursor.primaryKey===o[u]&&(d.push(cursor.value),u++),!(o.length>u))return void _idb.log("mobile - getItemsById - finished finding ids.");if(r)cursor.continuePrimaryKey(n,o[u]);else try{cursor.continue(o[u])}catch(e){_idb.log("mobile - getItemsById - Item not found."),cursor.continue()}}else _idb.log("getItemsById cursor - No more events to read (os, ids, ind, iValue): ",e,o,r,n)},l=_idb.db.transaction(e),g=l.objectStore(e);o=o.sort(function(e,o){return e-o}).filter(function(e,o,r){return!o||e!==r[o-1]}),r&&n?(s=g.index(r),c=IDBKeyRange.only(n),s.openCursor(c).onsuccess=a):g.openCursor().onsuccess=a,l.oncomplete=function(e){t(d)},l.onerror=function(e){_idb.log("Error reading IndexedDB - List by Ids: ",e.target),i(e)}})},saveListToIDBG:function(e,o,r){var n,t=this.db.transaction(e,"readwrite"),i=t.objectStore(e);if(r)n=i.clear(),n.onsuccess=function(e){for(var r in o)i.add(o[r])};else for(var s in o)i.put(o[s]);t.oncomplete=function(e){},t.onerror=function(e){console.error("saveListToIDBG error: ",e.target)}},removeListPromise:function(e,o){var r=this;return new Promise(function(n,t){var i=r.db.transaction(e,"readwrite"),s=i.objectStore(e);for(var c in o)s.delete(o[c]);i.oncomplete=function(e){n()},i.onerror=function(e){console.error("removeListFromIDBG error: ",e.target),t(e)}})},saveItemToIDB:function(e,o,r){var n=this.db.transaction(o,"readwrite"),t=n.objectStore(o);try{r?t.delete(e):(t.put(e),e.mod&&t.delete(e.mod))}catch(o){_idb.log("saveItemToIDB - ERROR while updating (json): ",JSON.stringify(e).substr(0,500))}n.oncomplete=function(o){_idb.log("saveItemToIDB completed successfully (json): ",JSON.stringify(e).substr(0,500))},n.onerror=function(e){_idb.log("saveItemToIDB - ERROR: ",e.target)}},searchTreePattern:function(e,o){return new Promise(function(r,n){var t,i,s,c,u=[],d=function(o){cursor=event.target.result,cursor?(s=cursor.source.keyPath!==cursor.value.etype?cursor.value.nIndex:" ",$m.checkPattern(s,e)&&u.push(cursor.value),cursor.continue()):_idb.log("IDBCursor - searchTreePattern - No more events to read")};_idb.log("IDB - searchTreePattern Begin (pattern): ",e);var a=_idb.ongoingTransaction=_idb.db.transaction("tree"),l=a.objectStore("tree");o.length?(c=o[o.length-1],t=l.index(c.etype),i=IDBKeyRange.only(c.eid),t.openCursor(i).onsuccess=d):l.openCursor().onsuccess=d,a.oncomplete=function(e){_idb.log("IndexedDB read completed - List of found elements by pattern: ",u.length),r(u)},a.onerror=function(o){_idb.log("Error reading IndexedDB - List of found elements by pattern: ",e),n(o)}})}};